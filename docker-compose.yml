version: '3.8'

services:
  swing-bot-monitor:
    build: .
    container_name: swing-bot-gtt-monitor
    restart: unless-stopped
    environment:
      # Required Upstox credentials
      - UPSTOX_ACCESS_TOKEN=${UPSTOX_ACCESS_TOKEN}
      - UPSTOX_API_KEY=${UPSTOX_API_KEY}
      - UPSTOX_API_SECRET=${UPSTOX_API_SECRET}

      # Optional notifications
      - TEAMS_WEBHOOK_URL=${TEAMS_WEBHOOK_URL}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}

      # Email notifications (if using SMTP)
      - SMTP_SERVER=${SMTP_SERVER}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}

    volumes:
      # Persist logs and outputs
      - ./logs:/app/logs
      - ./outputs:/app/outputs
      # Mount local data directory for persistence
      - ./data:/app/data

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0)"]
      interval: 5m
      timeout: 30s
      retries: 3
      start_period: 60s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: Nginx reverse proxy for health checks
  nginx:
    image: nginx:alpine
    container_name: swing-bot-nginx
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - swing-bot-monitor
    restart: unless-stopped
    profiles:
      - with-nginx