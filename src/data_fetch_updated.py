import os
import pandas as pd
import numpy as np
import requests
from datetime import datetime, timedelta
import time
from dotenv import load_dotenv
from .data_io import save_dataset

# Load environment variables
load_dotenv()

# Upstox API credentials from .env
API_KEY = os.getenv('UPSTOX_API_KEY')
API_SECRET = os.getenv('UPSTOX_API_SECRET')
ACCESS_TOKEN = os.getenv('UPSTOX_ACCESS_TOKEN')

# Instrument keys for Upstox (Nifty 50 + Popular ETFs)
instrument_keys = {
    # Nifty 50 Stocks
    'ADANIPORTS': 'NSE_EQ|INE742F01042',
    'ADANIENT': 'NSE_EQ|INE423A01024',
    'APOLLOHOSP': 'NSE_EQ|INE437A01024',
    'ASIANPAINT': 'NSE_EQ|INE021A01026',
    'AXISBANK': 'NSE_EQ|INE238A01034',
    'BAJAJ-AUTO': 'NSE_EQ|INE917I01010',
    'BAJFINANCE': 'NSE_EQ|INE296A01024',
    'BAJAJFINSV': 'NSE_EQ|INE918I01026',
    'BPCL': 'NSE_EQ|INE029A01023',
    'BHARTIARTL': 'NSE_EQ|INE397D01024',
    'BRITANNIA': 'NSE_EQ|INE216A01030',
    'CIPLA': 'NSE_EQ|INE059A01026',
    'COALINDIA': 'NSE_EQ|INE522F01014',
    'DIVISLAB': 'NSE_EQ|INE361B01024',
    'DRREDDY': 'NSE_EQ|INE089A01023',
    'EICHERMOT': 'NSE_EQ|INE066A01021',
    'GRASIM': 'NSE_EQ|INE047A01021',
    'HCLTECH': 'NSE_EQ|INE860A01027',
    'HDFCBANK': 'NSE_EQ|INE040A01034',
    'HDFCLIFE': 'NSE_EQ|INE795G01014',
    'HEROMOTOCO': 'NSE_EQ|INE158A01026',
    'HINDALCO': 'NSE_EQ|INE038A01020',
    'HINDUNILVR': 'NSE_EQ|INE030A01027',
    'ICICIBANK': 'NSE_EQ|INE090A01021',
    'INDUSINDBK': 'NSE_EQ|INE095A01012',
    'INFY': 'NSE_EQ|INE009A01021',
    'ITC': 'NSE_EQ|INE154A01025',
    'JSWSTEEL': 'NSE_EQ|INE019A01038',
    'KOTAKBANK': 'NSE_EQ|INE237A01028',
    'LT': 'NSE_EQ|INE018A01030',
    'M&M': 'NSE_EQ|INE101A01026',
    'MARUTI': 'NSE_EQ|INE585B01010',
    'NTPC': 'NSE_EQ|INE733E01010',
    'NESTLEIND': 'NSE_EQ|INE239A01024',
    'ONGC': 'NSE_EQ|INE213A01029',
    'POWERGRID': 'NSE_EQ|INE752E01010',
    'RELIANCE': 'NSE_EQ|INE002A01018',
    'SBILIFE': 'NSE_EQ|INE123W01016',
    'SHREECEM': 'NSE_EQ|INE070A01015',
    'SBIN': 'NSE_EQ|INE062A01020',
    'SUNPHARMA': 'NSE_EQ|INE044A01036',
    'TCS': 'NSE_EQ|INE467B01029',
    'TATACONSUM': 'NSE_EQ|INE192A01025',
    'TATAMOTORS': 'NSE_EQ|INE155A01022',
    'TATASTEEL': 'NSE_EQ|INE081A01020',
    'TECHM': 'NSE_EQ|INE669C01036',
    'TITAN': 'NSE_EQ|INE280A01028',
    'ULTRACEMCO': 'NSE_EQ|INE481G01011',
    'UPL': 'NSE_EQ|INE628A01036',
    'WIPRO': 'NSE_EQ|INE075A01022',
    'NIFTY': 'NSE_INDEX|Nifty 50',
    # All NSE ETFs with correct instrument keys from Upstox API
    'ABSLBANETF': 'NSE_EQ|INF209KB17D5',
    'ALPHAETF': 'NSE_EQ|INF769K01KU7',
    'ALPL30IETF': 'NSE_EQ|INF109KC17V7',
    'AUTOBEES': 'NSE_EQ|INF204KC1337',
    'AUTOIETF': 'NSE_EQ|INF109KC10V2',
    'AXISBNKETF': 'NSE_EQ|INF846K01X63',
    'AXISBPSETF': 'NSE_EQ|INF846K01Z04',
    'AXISCETF': 'NSE_EQ|INF846K016C7',
    'AXISGOLD': 'NSE_EQ|INF846K01W80',
    'AXISHCETF': 'NSE_EQ|INF846K01Z12',
    'AXISTECETF': 'NSE_EQ|INF846K01Y96',
    'BANKBEES': 'NSE_EQ|INF204KB15I9',
    'BANKBETF': 'NSE_EQ|INF0QA701714',
    'BANKETF': 'NSE_EQ|INF769K01KR3',
    'BANKIETF': 'NSE_EQ|INF109KC15I8',
    'BANKNIFTY1': 'NSE_EQ|INF174K01F59',
    'BBETF0432': 'NSE_EQ|INF754K01OB1',
    'BBNPNBETF': 'NSE_EQ|INF251K01TL6',
    'BFSI': 'NSE_EQ|INF769K01HI8',
    'BSE500IETF': 'NSE_EQ|INF109KC1V59',
    'BSLGOLDETF': 'NSE_EQ|INF209KB18D3',
    'BSLNIFTY': 'NSE_EQ|INF209KB19D1',
    'BSLSENETFG': 'NSE_EQ|INF209KB10E8',
    'CASHIETF': 'NSE_EQ|INF109K1A021',
    'COMMOIETF': 'NSE_EQ|INF109KC19O8',
    'CONSUMBEES': 'NSE_EQ|INF204KA1LD7',
    'CONSUMIETF': 'NSE_EQ|INF109KC1V42',
    'CPSEETF': 'NSE_EQ|INF457M01133',
    'DIVOPPBEES': 'NSE_EQ|INF204KA1MS3',
    'EBBETF0430': 'NSE_EQ|INF754K01KO2',
    'EBBETF0431': 'NSE_EQ|INF754K01LE1',
    'EBBETF0433': 'NSE_EQ|INF754K01QX0',
    'EQUAL50ADD': 'NSE_EQ|INF740KA1QK2',
    'ESG': 'NSE_EQ|INF769K01GS9',
    'EVIETF': 'NSE_EQ|INF109K1A153',
    'FINIETF': 'NSE_EQ|INF109KC17L8',
    'FMCGIETF': 'NSE_EQ|INF109KC19V3',
    'GILT5YBEES': 'NSE_EQ|INF204KC1030',
    'GOLD1': 'NSE_EQ|INF174KA1HJ8',
    'GOLDBEES': 'NSE_EQ|INF204KB17I5',
    'GOLDETF': 'NSE_EQ|INF769K01JP9',
    'GOLDIETF': 'NSE_EQ|INF109KC1NT3',
    'GOLDSHARE': 'NSE_EQ|INF789F1AUX7',
    'GSEC10IETF': 'NSE_EQ|INF109KC18O0',
    'GSEC10YEAR': 'NSE_EQ|INF769K01KF8',
    'GSEC5IETF': 'NSE_EQ|INF109KC14A8',
    'HANGSENG BEES-NAV': 'NSE_INDEX|HangSeng BeES-NAV',
    'HDFCGOLD': 'NSE_EQ|INF179KC1981',
    'HEALTHIETF': 'NSE_EQ|INF109KC1Q72',
    'HNGSNGBEES': 'NSE_EQ|INF204KB19I1',
    'INFRABEES': 'NSE_EQ|INF732E01268',
    'INFRAIETF': 'NSE_EQ|INF109KC16E5',
    'ITBEES': 'NSE_EQ|INF204KB15V2',
    'ITETF': 'NSE_EQ|INF769K01KV5',
    'ITIETF': 'NSE_EQ|INF109KC16I6',
    'IVZINGOLD': 'NSE_EQ|INF205K01361',
    'IVZINNIFTY': 'NSE_EQ|INF205K01DA9',
    'JETFREIGHT': 'NSE_EQ|INE982V01025',
    'JUNIORBEES': 'NSE_EQ|INF732E01045',
    'LICMFGOLD': 'NSE_EQ|INF397L01554',
    'LICNETFGSC': 'NSE_EQ|INF767K01MV5',
    'LICNETFN50': 'NSE_EQ|INF767K01OS7',
    'LICNETFSEN': 'NSE_EQ|INF767K01OT5',
    'LIQGRWBEES': 'NSE_EQ|INF204KC1FU1',
    'LIQUIDBEES': 'NSE_EQ|INF732E01037',
    'LIQUIDBETF': 'NSE_EQ|INF0QA701854',
    'LIQUIDETF': 'NSE_EQ|INF740KA1EU7',
    'LIQUIDIETF': 'NSE_EQ|INF109KC1KT9',
    'LOWVOLIETF': 'NSE_EQ|INF109KC19U5',
    'LTGILTBEES': 'NSE_EQ|INF204KB1882',
    'MAKEINDIA': 'NSE_EQ|INF769K01IB1',
    'MANUFGBEES': 'NSE_EQ|INF204KC1GH6',
    'METALIETF': 'NSE_EQ|INF109KC19W1',
    'MID150BEES': 'NSE_EQ|INF204KB1V68',
    'MIDCAPETF': 'NSE_EQ|INF769K01IC9',
    'MIDCAPIETF': 'NSE_EQ|INF109KC11W8',
    'MIDQ50ADD': 'NSE_EQ|INF740KA1QL0',
    'MIDSELIETF': 'NSE_EQ|INF109KC10W0',
    'MOM100': 'NSE_EQ|INF247L01023',
    'MOM30IETF': 'NSE_EQ|INF109KC17C7',
    'MOM50': 'NSE_EQ|INF247L01536',
    'MON100': 'NSE_EQ|INF247L01AP3',
    'NETF': 'NSE_EQ|INF277K015R5',
    'NEXT50IETF': 'NSE_EQ|INF109KC1NS5',
    'NIF100BEES': 'NSE_EQ|INF204K014N5',
    'NIF100IETF': 'NSE_EQ|INF109KC16V9',
    'NIF10GETF': 'NSE_EQ|INF789F1AZF3',
    'NIF5GETF': 'NSE_EQ|INF789F1AZE6',
    'NIFITETF': 'NSE_EQ|INF789F1AZD8',
    'NIFTY1': 'NSE_EQ|INF174K014P6',
    'NIFTYBEES': 'NSE_EQ|INF204KB14I2',
    'NIFTYBETF': 'NSE_EQ|INF0QA701722',
    'NIFTYETF': 'NSE_EQ|INF769K01EG9',
    'NIFTYIETF': 'NSE_EQ|INF109K012R6',
    'NV20': 'NSE_EQ|INF174K01Z71',
    'NV20BEES': 'NSE_EQ|INF204KB18I3',
    'NV20IETF': 'NSE_EQ|INF109KC11V0',
    'OILIETF': 'NSE_EQ|INF109KC18W3',
    'PHARMABEES': 'NSE_EQ|INF204KC1089',
    'PSUBANKADD': 'NSE_EQ|INF740KA1SY9',
    'PSUBNKBEES': 'NSE_EQ|INF204KB16I7',
    'PSUBNKIETF': 'NSE_EQ|INF109KC10S8',
    'PVTBANIETF': 'NSE_EQ|INF109KC18U7',
    'PVTBANKADD': 'NSE_EQ|INF740KA1TA7',
    'QNIFTY': 'NSE_EQ|INF082J01028',
    'QUAL30IETF': 'NSE_EQ|INF109KC18V5',
    'SBIETFCON': 'NSE_EQ|INF200KA1X17',
    'SBIETFIT': 'NSE_EQ|INF200KA1S14',
    'SBIETFPB': 'NSE_EQ|INF200KA1S22',
    'SBIETFQLTY': 'NSE_EQ|INF200KA1WX6',
    'SBILIQETF': 'NSE_EQ|INF200KB1969',
    'SBINEQWETF': 'NSE_EQ|INF200KB1282',
    'SDL26BEES': 'NSE_EQ|INF204KC1022',
    'SENSEXADD': 'NSE_EQ|INF740KA1SZ6',
    'SENSEXETF': 'NSE_EQ|INF769K01KT9',
    'SENSEXIETF': 'NSE_EQ|INF346A01034',
    'SETF10GILT': 'NSE_EQ|INF200KA1JT1',
    'SETFGOLD': 'NSE_EQ|INF200KA16D8',
    'SETFNIF50': 'NSE_EQ|INF200KA1FS1',
    'SETFNIFBK': 'NSE_EQ|INF200KA1580',
    'SETFNN50': 'NSE_EQ|INF200KA1598',
    'SHARIABEES': 'NSE_EQ|INF732E01128',
    'SILVERADD': 'NSE_EQ|INF740KA1RE3',
    'SILVERBEES': 'NSE_EQ|INF204KC1402',
    'SILVERETF': 'NSE_EQ|INF789F1AYK6',
    'SILVERIETF': 'NSE_EQ|INF109KC1Y56',
    'SNXT30BEES': 'NSE_EQ|INF204KC1EZ3',
    'TNIDETF': 'NSE_EQ|INF277KA1364',
    'TOP15IETF': 'NSE_EQ|INF109K1A344',
    'UTIBANKETF': 'NSE_EQ|INF789F1AUV1',
    'UTINIFTETF': 'NSE_EQ|INF789F1AZC0',
    'UTISENSETF': 'NSE_EQ|INF789FB1X58',
    'VAL30IETF': 'NSE_EQ|INF109KC16X5'
}

# NIFTY 50 stocks list
nifty_50_stocks = [
    'ADANIPORTS.NS', 'ADANIENT.NS', 'APOLLOHOSP.NS', 'ASIANPAINT.NS', 'AXISBANK.NS',
    'BAJAJ-AUTO.NS', 'BAJFINANCE.NS', 'BAJAJFINSV.NS', 'BPCL.NS', 'BHARTIARTL.NS',
    'BRITANNIA.NS', 'CIPLA.NS', 'COALINDIA.NS', 'DIVISLAB.NS', 'DRREDDY.NS',
    'EICHERMOT.NS', 'GRASIM.NS', 'HCLTECH.NS', 'HDFCBANK.NS', 'HDFCLIFE.NS',
    'HEROMOTOCO.NS', 'HINDALCO.NS', 'HINDUNILVR.NS', 'ICICIBANK.NS', 'INDUSINDBK.NS',
    'INFY.NS', 'ITC.NS', 'JSWSTEEL.NS', 'KOTAKBANK.NS', 'LT.NS',
    'M&M.NS', 'MARUTI.NS', 'NTPC.NS', 'NESTLEIND.NS', 'ONGC.NS',
    'POWERGRID.NS', 'RELIANCE.NS', 'SBILIFE.NS', 'SHREECEM.NS', 'SBIN.NS',
    'SUNPHARMA.NS', 'TCS.NS', 'TATACONSUM.NS', 'TATAMOTORS.NS', 'TATASTEEL.NS',
    'TECHM.NS', 'TITAN.NS', 'ULTRACEMCO.NS', 'UPL.NS', 'WIPRO.NS', 'NIFTY.NS'
]

# All NSE ETFs
nse_etfs = [
    'ABSLBANETF.NS',
    'ALPHAETF.NS',
    'ALPL30IETF.NS',
    'AUTOBEES.NS',
    'AUTOIETF.NS',
    'AXISBNKETF.NS',
    'AXISBPSETF.NS',
    'AXISCETF.NS',
    'AXISGOLD.NS',
    'AXISHCETF.NS',
    'AXISTECETF.NS',
    'BANKBEES.NS',
    'BANKBETF.NS',
    'BANKETF.NS',
    'BANKIETF.NS',
    'BANKNIFTY1.NS',
    'BBETF0432.NS',
    'BBNPNBETF.NS',
    'BFSI.NS',
    'BSE500IETF.NS',
    'BSLGOLDETF.NS',
    'BSLNIFTY.NS',
    'BSLSENETFG.NS',
    'CASHIETF.NS',
    'COMMOIETF.NS',
    'CONSUMBEES.NS',
    'CONSUMIETF.NS',
    'CPSEETF.NS',
    'DIVOPPBEES.NS',
    'EBBETF0430.NS',
    'EBBETF0431.NS',
    'EBBETF0433.NS',
    'EQUAL50ADD.NS',
    'ESG.NS',
    'EVIETF.NS',
    'FINIETF.NS',
    'FMCGIETF.NS',
    'GILT5YBEES.NS',
    'GOLD1.NS',
    'GOLDBEES.NS',
    'GOLDETF.NS',
    'GOLDIETF.NS',
    'GOLDSHARE.NS',
    'GSEC10IETF.NS',
    'GSEC10YEAR.NS',
    'GSEC5IETF.NS',
    'HANGSENG BEES-NAV.NS',
    'HDFCGOLD.NS',
    'HEALTHIETF.NS',
    'HNGSNGBEES.NS',
    'INFRABEES.NS',
    'INFRAIETF.NS',
    'ITBEES.NS',
    'ITETF.NS',
    'ITIETF.NS',
    'IVZINGOLD.NS',
    'IVZINNIFTY.NS',
    'JETFREIGHT.NS',
    'JUNIORBEES.NS',
    'LICMFGOLD.NS',
    'LICNETFGSC.NS',
    'LICNETFN50.NS',
    'LICNETFSEN.NS',
    'LIQGRWBEES.NS',
    'LIQUIDBEES.NS',
    'LIQUIDBETF.NS',
    'LIQUIDETF.NS',
    'LIQUIDIETF.NS',
    'LOWVOLIETF.NS',
    'LTGILTBEES.NS',
    'MAKEINDIA.NS',
    'MANUFGBEES.NS',
    'METALIETF.NS',
    'MID150BEES.NS',
    'MIDCAPETF.NS',
    'MIDCAPIETF.NS',
    'MIDQ50ADD.NS',
    'MIDSELIETF.NS',
    'MOM100.NS',
    'MOM30IETF.NS',
    'MOM50.NS',
    'MON100.NS',
    'NETF.NS',
    'NEXT50IETF.NS',
    'NIF100BEES.NS',
    'NIF100IETF.NS',
    'NIF10GETF.NS',
    'NIF5GETF.NS',
    'NIFITETF.NS',
    'NIFTY1.NS',
    'NIFTYBEES.NS',
    'NIFTYBETF.NS',
    'NIFTYETF.NS',
    'NIFTYIETF.NS',
    'NV20.NS',
    'NV20BEES.NS',
    'NV20IETF.NS',
    'OILIETF.NS',
    'PHARMABEES.NS',
    'PSUBANKADD.NS',
    'PSUBNKBEES.NS',
    'PSUBNKIETF.NS',
    'PVTBANIETF.NS',
    'PVTBANKADD.NS',
    'QNIFTY.NS',
    'QUAL30IETF.NS',
    'SBIETFCON.NS',
    'SBIETFIT.NS',
    'SBIETFPB.NS',
    'SBIETFQLTY.NS',
    'SBILIQETF.NS',
    'SBINEQWETF.NS',
    'SDL26BEES.NS',
    'SENSEXADD.NS',
    'SENSEXETF.NS',
    'SENSEXIETF.NS',
    'SETF10GILT.NS',
    'SETFGOLD.NS',
    'SETFNIF50.NS',
    'SETFNIFBK.NS',
    'SETFNN50.NS',
    'SHARIABEES.NS',
    'SILVERADD.NS',
    'SILVERBEES.NS',
    'SILVERETF.NS',
    'SILVERIETF.NS',
    'SNXT30BEES.NS',
    'TNIDETF.NS',
    'TOP15IETF.NS',
    'UTIBANKETF.NS',
    'UTINIFTETF.NS',
    'UTISENSETF.NS',
    'VAL30IETF.NS'
]

# Combined list of all instruments (stocks + ETFs)
all_instruments = nifty_50_stocks + nse_etfs